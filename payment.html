<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Payment</title>
  <link rel="stylesheet" href="css/bootstrap.css">
  <style>
    .item-row{border-bottom:1px solid #e5e5e5;padding:12px 0}
    .item-img{width:50px;height:50px;object-fit:cover}
  </style>
</head>
<body>

<div class="container" style="margin-top:50px;max-width:800px">
  <h2>Payment</h2>
  <p class="text-muted">Review your cart and choose an action (demo).</p>

  <div id="itemsList"></div>

  <div class="text-right" style="margin-top:18px">
    <h4 id="totalAmount">Total: ₹ 0</h4>
  </div>

  <div style="max-width:520px;margin:18px auto 0">
    <div class="form-group">
      <label>Full Name</label>
      <input id="checkoutName" class="form-control" placeholder="Full name">
    </div>
    <div class="form-group">
      <label>Shipping Address</label>
      <textarea id="checkoutAddress" class="form-control" placeholder="Shipping address"></textarea>
    </div>
  </div>

  <div style="max-width:420px;margin:18px auto;text-align:center">
    <div class="form-group">
      <label style="display:block;margin-bottom:6px;font-weight:600">Enter Mobile to Process Transaction</label>
      <input id="checkoutMobile" class="form-control" placeholder="Mobile number" style="max-width:320px;margin:0 auto;text-align:center;font-size:16px;padding:12px">
    </div>
  </div>

  <div class="row" style="margin-top:24px">
    <div class="col-sm-6 col-sm-offset-3">
      <a id="proceedCheckout" class="btn btn-primary btn-block">Proceed to Checkout</a>
    </div>
  </div>

</div>

<!-- OTP Modal -->
<div id="otpModal" style="display:none;position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;padding:18px;border-radius:6px;width:320px;margin:0 auto">
    <h4 style="margin-top:0">Enter OTP</h4>
    <p style="font-size:13px;margin-bottom:6px">OTP sent to <strong id="otpSentTo"></strong></p>
    <p style="font-size:12px;color:#888;margin-top:0">Demo OTP: <strong id="demoOtpValue" style="letter-spacing:2px"></strong></p>
    <div class="form-group"><input id="otpInput" class="form-control" placeholder="6-digit OTP"></div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn btn-primary" onclick="verifyOtpAndPay()">Verify & Pay</button>
      <button id="resendOtpBtn" class="btn btn-default" onclick="resendOtp()">Resend</button>
      <small id="resendTimer" style="margin-left:6px;color:#666"> </small>
      <button class="btn btn-link pull-right" style="margin-left:auto" onclick="document.getElementById('otpModal').style.display='none'">Cancel</button>
    </div>
  </div>
</div>

<!-- Spinner overlay -->
<div id="demoSpinner" style="display:none;position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:10000">
  <div style="display:flex;align-items:center;color:#fff">
    <div style="width:48px;height:48px;border-radius:50%;border:5px solid rgba(255,255,255,0.25);border-top-color:#fff;animation:spin 1s linear infinite;margin-right:12px"></div>
    <div class="spinner-text">Working...</div>
  </div>
</div>

<style>@keyframes spin{to{transform:rotate(360deg)}}</style>

<script>
// Read cart from localStorage
var productsJson = localStorage.getItem('cartProducts');
var products = [];
if(productsJson){
  try{ products = JSON.parse(productsJson) }catch(e){ products = [] }
}

var total = localStorage.getItem('cartTotal') || 0;

var $items = document.getElementById('itemsList');
if(products.length === 0){
  $items.innerHTML = '<div class="alert alert-info">Your cart is empty.</div>';
} else {
  var html = '';
  products.forEach(function(p){
    html += '<div class="item-row row">'
         + '<div class="col-xs-2"><img class="item-img" src="'+(p.image||'images/si.jpg')+'" alt=""></div>'
         + '<div class="col-xs-6">'+(p.name||'Product')+'<br><small class="text-muted">Qty: '+(p.quantity||1)+'</small></div>'
         + '<div class="col-xs-4 text-right">₹ '+((p.price||0)* (p.quantity||1))+'</div>'
         + '</div>';
  });
  $items.innerHTML = html;
}

document.getElementById('totalAmount').innerText = 'Total: ₹ ' + total;
// --- Run OTP flow here (no checkout redirect) ---
var __demoOtp = null;
var __otpExpiresAt = 0;

document.getElementById('proceedCheckout').addEventListener('click', function(){
  var mobile = (document.getElementById('checkoutMobile')||{}).value.trim() || '';
  var name = (document.getElementById('checkoutName')||{}).value.trim() || '';
  var address = (document.getElementById('checkoutAddress')||{}).value.trim() || '';
  var emailEl = document.getElementById('checkoutEmail');
  var email = (emailEl && (emailEl.value||'').trim()) || '';
  if(!name || !address || !mobile){
    alert('Please enter full name, shipping address and mobile number to proceed.');
    return;
  }

  // require login/register before starting payment
  try{
    var cur = JSON.parse(localStorage.getItem('currentUser')||'null');
    if(!cur){
      // save form values so we can resume after login
      localStorage.setItem('checkoutName', name);
      localStorage.setItem('checkoutAddress', address);
      localStorage.setItem('checkoutMobile', mobile);
      localStorage.setItem('checkoutEmail', email);
      localStorage.setItem('returnTo', 'payment.html');
      window.location.href = 'login.html';
      return;
    }
  }catch(e){}

  window.__pendingOrder = {
    id: 'ORD' + Date.now(),
    date: new Date().toISOString(),
    products: JSON.parse(localStorage.getItem('cartProducts')||'[]'),
    total: total,
    shipping: { name: name, email: email, mobile: mobile, address: address }
  };

  sendOtpToMobile(mobile);
});

function sendOtpToMobile(mobile){
  // Try real API first (if available), otherwise fall back to demo OTP
  var API_BASE = window.API_BASE || '/api';
  showSpinner('Sending OTP to ' + mobile + '...');
  fetch(API_BASE + '/api/send-otp', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ mobile: mobile }) })
    .then(function(r){ return r.json(); })
    .then(function(json){
      hideSpinner();
      if(json && json.ok){
        // If server returned demoOtp (no SMS provider), show it for testing
        if(json.demoOtp) document.getElementById('demoOtpValue').innerText = json.demoOtp;
        document.getElementById('otpSentTo').innerText = mobile;
        document.getElementById('otpModal').style.display = 'block';
        startOtpCountdown(30);
      }else{
        hideSpinner();
        // fallback to client-side demo OTP
        __demoOtp = Math.floor(100000 + Math.random()*900000).toString();
        __otpExpiresAt = Date.now() + (5*60*1000);
        console.log('Fallback demo OTP:', __demoOtp);
        document.getElementById('demoOtpValue').innerText = __demoOtp;
        document.getElementById('otpSentTo').innerText = mobile;
        document.getElementById('otpModal').style.display = 'block';
        startOtpCountdown(30);
      }
    })
    .catch(function(){
      hideSpinner();
      // network error -> fallback demo
      __demoOtp = Math.floor(100000 + Math.random()*900000).toString();
      __otpExpiresAt = Date.now() + (5*60*1000);
      console.log('Fallback demo OTP:', __demoOtp);
      document.getElementById('demoOtpValue').innerText = __demoOtp;
      document.getElementById('otpSentTo').innerText = mobile;
      document.getElementById('otpModal').style.display = 'block';
      startOtpCountdown(30);
    });
}

function startOtpCountdown(seconds){
  var el = document.getElementById('resendTimer');
  var btn = document.getElementById('resendOtpBtn');
  if(!el || !btn) return;
  btn.disabled = true;
  el.innerText = seconds + 's';
  var t = setInterval(function(){
    seconds--; el.innerText = seconds + 's';
    if(seconds<=0){ clearInterval(t); el.innerText = 'Expired'; btn.disabled = false; }
  },1000);
}

function resendOtp(){
  var mobile = document.getElementById('otpSentTo').innerText || '';
  if(!mobile) return; sendOtpToMobile(mobile);
}

function verifyOtpAndPay(){
  var val = (document.getElementById('otpInput')||{}).value.trim();
  if(!val){ alert('Enter OTP'); return; }

  // If server was used, verify via API; otherwise check demo OTP
  var API_BASE = window.API_BASE || '/api';
  showSpinner('Verifying OTP...');
  fetch(API_BASE + '/api/verify-otp', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ mobile: document.getElementById('otpSentTo').innerText, otp: val, order: window.__pendingOrder }) })
    .then(function(r){ return r.json(); })
    .then(function(json){
      hideSpinner();
      if(json && json.ok){
        finalizeOrder();
      }else{
        // backend responded with error -> show message, but allow demo fallback
        if(json && json.error){ alert('OTP verify failed: ' + json.error); }
        // fallback: if demo OTP matches, accept it
        if(val === __demoOtp) finalizeOrder();
      }
    })
    .catch(function(){
      hideSpinner();
      // network failure -> fallback to demo OTP behavior
      if(val === __demoOtp) finalizeOrder();
      else alert('OTP verification failed (network).');
    });
}

function finalizeOrder(){
  document.getElementById('otpModal').style.display = 'none';
  showSpinner('Processing payment...');
  setTimeout(function(){
    hideSpinner();
    var order = window.__pendingOrder || null;
    if(order){
      try{ var orders = JSON.parse(localStorage.getItem('orders')||'[]'); }catch(e){ orders = []; }
      orders.unshift(order); localStorage.setItem('orders', JSON.stringify(orders));
      // clear cart
      localStorage.removeItem('cartProducts'); localStorage.removeItem('cartTotal'); localStorage.removeItem('products');

      // try to send confirmation email via API, but don't block
      var API_BASE = window.API_BASE || 'http://localhost:3000';
      fetch(API_BASE + '/api/send-email', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ to: order.shipping.email, subject: 'Order ' + order.id + ' Confirmation', text: 'Thank you for your order. Order ID: ' + order.id + '\nTotal: ' + order.total }) }).catch(function(){});

      window.location.href = 'success.html';
    }else{ alert('Order data missing.'); }
  }, 1200);
}

// spinner helpers
function showSpinner(text){
  var s = document.getElementById('demoSpinner'); if(!s) return;
  s.querySelector('.spinner-text').innerText = text || 'Working...'; s.style.display = 'flex';
}
function hideSpinner(){ var s = document.getElementById('demoSpinner'); if(s) s.style.display = 'none'; }
</script>

</body>
</html>
