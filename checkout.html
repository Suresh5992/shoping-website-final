<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <link rel="stylesheet" href="css/bootstrap.css">
  <style>
    #otpModal{ display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999 }
    #otpModal .modal-box{ background:#fff; padding:20px; border-radius:6px; width:320px; max-width:90%; }
    #demoSpinner{ display:none; position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:10000 }
    .spinner-circle{ width:48px; height:48px; border-radius:50%; border:5px solid rgba(255,255,255,0.25); border-top-color:#fff; animation:spin 1s linear infinite }
    .spinner-text{ color:#fff; margin-left:12px }
    @keyframes spin{ to{ transform:rotate(360deg) } }
  </style>
</head>

<body>

<div class="container" style="margin-top:50px">

  <h2>Checkout / Payment</h2>

  <form>

    <div class="form-group">
      <label>Full Name</label>
      <input id="shippingName" type="text" class="form-control" required>
    </div>

    <div class="form-group">
      <label>Email</label>
      <input id="shippingEmail" type="email" class="form-control" required>
    </div>

    <div class="form-group">
      <label>Mobile</label>
      <input id="shippingMobile" type="text" class="form-control" required>
    </div>

    <div class="form-group">
      <label>Shipping Address</label>
      <textarea id="shippingAddress" class="form-control" required></textarea>
    </div>

    <h3 id="totalAmount"></h3>

    <button type="button"
            onclick="startOtpFlow()"
            class="btn btn-success">
      Pay Now
    </button>

  </form>

</div>

<!-- OTP Modal -->
<div id="otpModal">
  <div class="modal-box">
    <h4>Enter OTP</h4>
    <p style="font-size:13px;margin-bottom:8px">OTP sent to <strong id="otpSentTo"></strong></p>
    <p style="font-size:12px;color:#888;margin-top:0">Demo OTP: <strong id="demoOtpValue" style="letter-spacing:2px"></strong></p>
    <div class="form-group">
      <input id="otpInput" class="form-control" placeholder="Enter 6-digit OTP">
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn btn-primary" onclick="verifyOtpAndPay()">Verify & Pay</button>
      <button id="resendOtpBtn" class="btn btn-default" onclick="resendOtp()">Resend</button>
      <small id="resendTimer" style="margin-left:6px;color:#666"> </small>
      <button class="btn btn-link pull-right" style="margin-left:auto" onclick="document.getElementById('otpModal').style.display='none'">Cancel</button>
    </div>
  </div>
</div>

<!-- Spinner overlay -->
<div id="demoSpinner" style="display:none;flex-direction:row">
  <div style="display:flex;align-items:center">
    <div class="spinner-circle"></div>
    <div class="spinner-text">Working...</div>
  </div>
</div>

<script>
var total = localStorage.getItem("cartTotal") || 0;

document.getElementById("totalAmount")
  .innerHTML = "Total Amount: â‚¹ " + total;

// Prefill mobile if provided from payment page
(function(){
  try{
    var saved = localStorage.getItem('checkoutMobile');
    if(saved){
      var el = document.getElementById('shippingMobile');
      if(el) el.value = saved;
      localStorage.removeItem('checkoutMobile');
    }
  }catch(e){}
})();

// Prefill name and address if available
(function(){
  try{
    var n = localStorage.getItem('checkoutName');
    var a = localStorage.getItem('checkoutAddress');
    if(n){ var eln = document.getElementById('shippingName'); if(eln) eln.value = n; localStorage.removeItem('checkoutName'); }
    if(a){ var ela = document.getElementById('shippingAddress'); if(ela) ela.value = a; localStorage.removeItem('checkoutAddress'); }
  }catch(e){}
})();

// --- OTP / Demo payment flow ---
var __demoOtp = null;
var __otpExpiresAt = 0;

function startOtpFlow(){
  var name = (document.getElementById('shippingName')||{}).value || '';
  var email = (document.getElementById('shippingEmail')||{}).value || '';
  var mobile = (document.getElementById('shippingMobile')||{}).value || '';
  var address = (document.getElementById('shippingAddress')||{}).value || '';

  if(!name || !email || !mobile || !address){
    alert('Please fill all fields before proceeding.');
    return;
  }

  // create a temporary order payload stored on window for later use
  window.__pendingOrder = {
    id: 'ORD' + Date.now(),
    date: new Date().toISOString(),
    products: JSON.parse(localStorage.getItem('cartProducts')||'[]'),
    total: total,
    shipping: { name: name, email: email, mobile: mobile, address: address }
  };

  sendOtpToMobile(mobile);
}

function sendOtpToMobile(mobile){
  // demo: generate 6-digit OTP and "send" it
  __demoOtp = Math.floor(100000 + Math.random()*900000).toString();
  __otpExpiresAt = Date.now() + (5*60*1000); // 5 minutes

  // show spinner while "sending"
  showSpinner('Sending OTP to ' + mobile + '...');
  console.log('Demo OTP (visible only in console):', __demoOtp);

  setTimeout(function(){
    hideSpinner();
    // show OTP modal
    document.getElementById('demoOtpValue').innerText = __demoOtp; // demo helper
    document.getElementById('otpSentTo').innerText = mobile;
    document.getElementById('otpModal').style.display = 'block';
    startOtpCountdown(30);
  }, 1200);
}

function startOtpCountdown(seconds){
  var el = document.getElementById('resendTimer');
  var btn = document.getElementById('resendOtpBtn');
  btn.disabled = true;
  el.innerText = seconds + 's';
  var t = setInterval(function(){
    seconds--;
    el.innerText = seconds + 's';
    if(seconds<=0){
      clearInterval(t); el.innerText = 'Expired'; btn.disabled = false;
    }
  },1000);
}

function resendOtp(){
  var mobile = document.getElementById('otpSentTo').innerText || '';
  if(!mobile) return;
  sendOtpToMobile(mobile);
}

function verifyOtpAndPay(){
  var val = document.getElementById('otpInput').value.trim();
  if(!val){ alert('Enter OTP'); return; }
  if(Date.now() > __otpExpiresAt){ alert('OTP expired. Please resend.'); return; }
  if(val !== __demoOtp){ alert('Incorrect OTP.'); return; }

  // proceed with payment processing animation
  document.getElementById('otpModal').style.display = 'none';
  showSpinner('Processing payment...');

  setTimeout(function(){
    hideSpinner();
    // finalize order (store in localStorage)
    var order = window.__pendingOrder || null;
    if(order){
      try{ var orders = JSON.parse(localStorage.getItem('orders')||'[]'); }catch(e){ orders = []; }
      orders.unshift(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      // clear cart
      localStorage.removeItem('cartProducts');
      localStorage.removeItem('cartTotal');
      localStorage.removeItem('products');

      // open mail client with confirmation (demo)
      try{
        var mailto = 'mailto:' + encodeURIComponent(order.shipping.email)
          + '?subject=' + encodeURIComponent('Order ' + order.id + ' Confirmation')
          + '&body=' + encodeURIComponent('Thank you for your order.\nOrder ID: ' + order.id + '\nTotal: ' + order.total);
        window.open(mailto);
      }catch(e){/*ignore*/}

      window.location.href = 'success.html';
    }else{
      alert('Order data missing.');
    }
  }, 1200);
}

// spinner helpers
function showSpinner(text){
  var s = document.getElementById('demoSpinner');
  s.querySelector('.spinner-text').innerText = text || 'Working...';
  s.style.display = 'flex';
}
function hideSpinner(){
  document.getElementById('demoSpinner').style.display = 'none';
}

</script>

</body>
</html>
